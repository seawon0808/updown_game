<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Up Down ê²Œì„ â€” ë””ë²„ê·¸ ì¹œí™”ì </title>
<style>
  :root{--bg:#f6f7fb;--card:#fff;--muted:#666}
  html,body{height:100%;margin:0}
  body{
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",Arial;
    background:var(--bg);padding:24px;color:#111;
  }
  .container{max-width:1300px;margin:0 auto;background:var(--card);padding:24px;border-radius:12px;box-shadow:0 16px 30px rgba(0,0,0,0.06)}
  h2{margin:0 0 12px}
  .grid{display:grid;grid-template-columns:1.15fr 1fr;gap:20px;align-items:start}
  @media(max-width:900px){.grid{grid-template-columns:1fr}}
  .score{font-size:56px;font-weight:900}
  .label{font-size:22px;font-weight:800;color:var(--muted)}
  .meta{display:flex;gap:12px;margin-top:6px;color:var(--muted)}
  .box{background:#f1f1f1;padding:12px;border-radius:10px;min-height:44px;display:flex;align-items:center;font-size:16px}
  .controls{display:flex;flex-direction:column;gap:10px}
  input[type="text"], button{box-sizing:border-box;padding:12px;font-size:18px;border-radius:10px;border:1px solid #d6d6d6;width:100%}
  input[type="text"]{-webkit-appearance:none;appearance:none}
  button{background:#fafafa;cursor:pointer;font-weight:700}
  button:disabled{opacity:0.6;cursor:not-allowed}
  .logs{display:flex;flex-direction:column;gap:12px}
  .log{background:#fafafa;padding:12px;border-radius:10px;max-height:420px;overflow:auto;font-size:15px;white-space:pre-wrap;border:1px solid #efefef}
  .top-controls{display:flex;gap:10px;align-items:center;margin-bottom:8px}
  .small-muted{font-size:13px;color:var(--muted)}
  .debug-console{background:#111;color:#fff;padding:8px;border-radius:8px;font-family:monospace;font-size:13px;max-height:120px;overflow:auto}
</style>
</head>
<body>
  <div class="container">
    <div class="top-controls">
      <h2 style="margin:0">Up Down ê²Œì„ (1~100)</h2>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <button id="resetBtn" type="button">Reset game data</button>
        <div class="small-muted">Debug console below (for troubleshooting)</div>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="game">
        <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap">
          <div class="score"><span id="pscore">0</span> : <span id="cscore">0</span></div>
          <div>
            <div class="label">ë³´ì •ê³  : ì»´í“¨í„°</div>
            <div class="meta">
              <div>í˜„ì¬ ì°¨ë¡€: <strong id="turnPlayer"></strong></div>
              <div>í„´ ìˆ˜: <strong id="turnCount">0</strong></div>
            </div>
          </div>
        </div>

        <div id="message" class="box" aria-live="polite">ê²Œì„ ì‹œì‘!</div>

        <div class="controls" style="margin-top:8px">
          <input id="guessInput" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="1~100 ì…ë ¥" aria-label="ìˆ«ì ì…ë ¥ (1~100)">
          <button id="submitBtn" type="button">í™•ì¸</button>
        </div>

        <div style="margin-top:12px">
          <div class="small-muted">If input still doesn't register: open the browser console (F12 â†’ Console) and paste its output here.</div>
        </div>

        <div style="margin-top:12px">
          <div class="small-muted">Console log (latest events):</div>
          <div id="debug" class="debug-console"></div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="logs">
        <div>
          <h4 style="margin:8px 0">ğŸ“œ í˜„ì¬ ê²Œì„ ë¡œê·¸</h4>
          <div class="log" id="roundLog"></div>
        </div>

        <div>
          <h4 style="margin:8px 0">ğŸ“š ê²Œì„ ê¸°ë¡</h4>
          <div class="log" id="gameLog"></div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ---------- CONFIG ---------- */
const STORAGE_KEY = "updown_optimal_v1";
const POST_RESULT_DELAY = 2000;
const COMPUTER_THINK_DELAY = 800;

/* ---------- DOM ---------- */
const el = id => document.getElementById(id);
const pscore = el('pscore'), cscore = el('cscore');
const turnPlayer = el('turnPlayer'), turnCount = el('turnCount');
const message = el('message'), guessInput = el('guessInput'), submitBtn = el('submitBtn');
const roundLog = el('roundLog'), gameLog = el('gameLog');
const resetBtn = el('resetBtn'), debugEl = el('debug');

/* ---------- debug helper ---------- */
function debug(...args){
  const text = args.map(a => (typeof a === 'object' ? JSON.stringify(a) : String(a))).join(' ');
  console.debug(text);
  // show last 2000 chars in debug console
  debugEl.textContent = (debugEl.textContent + '\n' + text).slice(-2000);
}

/* ---------- safe escape ---------- */
function escapeHtml(s){ return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* ---------- Game data ---------- */
function newRound(){ return { answer: Math.floor(Math.random()*100)+1, low:1, high:100, turn:0, playerTurn:true, log:[], over:false }; }

function load(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(raw){
    try{
      const obj = JSON.parse(raw);
      // defensive normalization
      if(!obj.round || typeof obj.round !== 'object') obj.round = newRound();
      // ensure required fields exist
      obj.round.low = Number.isInteger(obj.round.low) ? obj.round.low : 1;
      obj.round.high = Number.isInteger(obj.round.high) ? obj.round.high : 100;
      obj.round.turn = Number.isInteger(obj.round.turn) ? obj.round.turn : 0;
      obj.round.playerTurn = typeof obj.round.playerTurn === 'boolean' ? obj.round.playerTurn : true;
      // If round.over is present as true (stale end state), reset it so input works.
      // We keep scores/games but resume with a fresh round if stuck.
      if(obj.round.over){
        debug('load(): saved round.over=true -> clearing to allow new input');
        obj.round = newRound();
      }
      obj.playerScore = Number.isInteger(obj.playerScore) ? obj.playerScore : 0;
      obj.computerScore = Number.isInteger(obj.computerScore) ? obj.computerScore : 0;
      obj.games = Array.isArray(obj.games) ? obj.games : [];
      return obj;
    }catch(e){
      console.warn('load parse failed', e);
    }
  }
  return { playerScore:0, computerScore:0, games:[], round:newRound() };
}

let data = load();
let countdownInterval = null;
function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); debug('save() ->', data); }

/* ---------- render ---------- */
function render(msg){
  pscore.textContent = data.playerScore;
  cscore.textContent = data.computerScore;
  turnPlayer.textContent = data.round.playerTurn ? "ë³´ì •ê³ " : "ì»´í“¨í„°";
  turnCount.textContent = data.round.turn;
  if(typeof msg === 'string' && msg !== '') message.textContent = msg;

  roundLog.innerHTML = data.round.log.map(l => `<div>${escapeHtml(l)}</div>`).join('');
  gameLog.innerHTML = data.games.map((g,i) => `<div>ê²Œì„ ${i+1}: ${escapeHtml(g)}</div>`).join('');

  const disabled = !!data.round.over;
  guessInput.disabled = disabled;
  submitBtn.disabled = disabled;
}

/* ---------- endGame ---------- */
function endGame(winner){
  if(winner === "ë³´ì •ê³ ") data.playerScore++; else data.computerScore++;
  data.games.unshift(`${winner} ìŠ¹ (ì •ë‹µ ${data.round.answer}, ${data.round.turn}í„´)`);
  data.round.over = true;
  save();

  let remaining = 5;
  render(`ğŸ‰ ${winner} ì •ë‹µ! ${remaining}ì´ˆ í›„ ìƒˆ ê²Œì„ ì‹œì‘`);
  if(countdownInterval) clearInterval(countdownInterval);
  countdownInterval = setInterval(()=>{
    remaining--;
    if(remaining > 0) render(`ğŸ‰ ${winner} ì •ë‹µ! ${remaining}ì´ˆ í›„ ìƒˆ ê²Œì„ ì‹œì‘`);
    else { clearInterval(countdownInterval); countdownInterval=null; data.round = newRound(); save(); render("ìƒˆ ê²Œì„ ì‹œì‘!"); }
  },1000);
}

/* ---------- processGuess ---------- */
function processGuess(who, guess){
  if(data.round.over){ debug('processGuess aborted: round.over true'); return; }

  data.round.turn++;
  let result;
  if(guess < data.round.answer){ result='UP'; data.round.low = Math.max(data.round.low, guess+1); }
  else if(guess > data.round.answer){ result='DOWN'; data.round.high = Math.min(data.round.high, guess-1); }
  else { result='CORRECT'; }

  data.round.log.unshift(`${who}: ${guess} â†’ ${result}`);
  save();

  debug('processGuess', {who, guess, result, low:data.round.low, high:data.round.high});

  // Show result immediately
  render(`${who}: ${guess} â†’ ${result}`);

  if(result === 'CORRECT'){ endGame(who); return; }

  // lock inputs while user reads result
  guessInput.disabled = true;
  submitBtn.disabled = true;

  setTimeout(()=>{
    data.round.playerTurn = !data.round.playerTurn;
    // re-enable if round not over
    guessInput.disabled = !!data.round.over;
    submitBtn.disabled = !!data.round.over;
    save();
    render();
    debug('post-read: turn switched, playerTurn=', data.round.playerTurn);
    if(!data.round.playerTurn && !data.round.over) computerGuess();
  }, POST_RESULT_DELAY);
}

/* ---------- computerGuess ---------- */
function computerGuess(){
  if(data.round.low > data.round.high){ data.round.low =1; data.round.high =100; debug('computerGuess: fixed invalid range'); }
  const guess = Math.floor((data.round.low + data.round.high)/2);
  debug('computer will guess after think delay', {guess});
  setTimeout(()=> processGuess('ì»´í“¨í„°', guess), COMPUTER_THINK_DELAY);
}

/* ---------- input handling ---------- */
function handleSubmit(){
  debug('handleSubmit invoked. playerTurn=', data.round.playerTurn, 'round.over=', data.round.over);
  if(!data.round.playerTurn || data.round.over){ debug('submit blocked (not player turn or round over)'); return; }

  const raw = String(guessInput.value || '').trim();
  if(raw === ''){ render('â— 1~100 ì‚¬ì´ ìˆ«ìë§Œ ì…ë ¥'); return; }
  const n = Number(raw);
  if(!Number.isInteger(n) || n<1 || n>100){ render('â— 1~100 ì‚¬ì´ ìˆ«ìë§Œ ì…ë ¥'); guessInput.value=''; return; }

  guessInput.value='';
  processGuess('ë³´ì •ê³ ', n);
}

submitBtn.addEventListener('click', handleSubmit);
guessInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter'){ e.preventDefault(); handleSubmit(); } });
submitBtn.addEventListener('keydown', (e)=>{ if(e.key === 'Enter'){ e.preventDefault(); handleSubmit(); } });

/* ---------- reset ---------- */
resetBtn.addEventListener('click', ()=>{
  if(!confirm('ê²Œì„ ê¸°ë¡ê³¼ ì €ì¥ëœ ìƒíƒœë¥¼ ì‚­ì œí•˜ê³  ìƒˆë¡œ ì‹œì‘í•˜ì‹œê² ì–´ìš”?')) return;
  localStorage.removeItem(STORAGE_KEY);
  data = load();
  save();
  render('ë°ì´í„° ì´ˆê¸°í™”ë¨ â€” ìƒˆ ê²Œì„ ì‹œì‘!');
  debug('reset: localStorage cleared and reloaded');
});

/* ---------- multi-tab sync ---------- */
window.addEventListener('storage', (e)=>{
  if(e.key === STORAGE_KEY && e.newValue){
    try{ data = JSON.parse(e.newValue); render('ğŸ”„ ë‹¤ë¥¸ ì°½ê³¼ ë™ê¸°í™”ë¨'); debug('storage event loaded data'); }
    catch(err){ debug('storage parse fail', err); }
  }
});

/* ---------- initial ---------- */
debug('initial load', data);
render('ê²Œì„ ì‹œì‘!');
</script>
</body>
</html>
